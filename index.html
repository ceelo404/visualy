<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualy - AI Property Matcher</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        #details-modal.hidden {
            display: none;
        }
        .image-loader {
            background-color: #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 0.5rem;
            color: #6b7280;
        }
        .sort-btn-active, .nav-btn-active {
            background-color: #4f46e5 !important;
            color: #ffffff !important;
        }
        .like-btn {
            cursor: pointer;
            transition: color 0.2s ease-in-out, transform 0.2s ease-in-out;
        }
        .like-btn.liked {
            color: #ef4444; /* red-500 */
            transform: scale(1.1);
        }
        .like-btn:hover {
            color: #f87171; /* red-400 */
        }
        .vibe-option {
            transition: all 0.2s ease-in-out;
        }
        .vibe-option.selected {
            transform: scale(1.05);
            box-shadow: 0 0 0 3px #818cf8; /* indigo-400 */
            background-color: rgba(255, 255, 255, 0.2) !important;
        }
        .color-swatch {
            width: 24px;
            height: 24px;
            border-radius: 9999px;
            display: inline-block;
            margin: 0 2px;
            border: 1px solid rgba(0,0,0,0.1);
        }
        .placeholder-white::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        .star-rating i {
            color: #f59e0b; /* amber-500 */
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app" class="min-h-screen">
        <!-- Header -->
        <header class="gradient-bg text-white shadow-md p-6 sticky top-0 z-40">
            <div class="container mx-auto max-w-5xl flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <svg class="w-10 h-10" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 4.5C7 4.5 2.73 7.61 1 12C2.73 16.39 7 19.5 12 19.5C17 19.5 21.27 16.39 23 12C21.27 7.61 17 4.5 12 4.5ZM12 17C9.24 17 7 14.76 7 12C7 9.24 9.24 7 12 7C14.76 7 17 9.24 17 12C17 14.76 14.76 17 12 17ZM12 9C10.34 9 9 10.34 9 12C9 13.66 10.34 15 12 15C13.66 15 15 13.66 15 12C15 10.34 13.66 9 12 9Z" fill="white"/>
                    </svg>
                    <h1 class="text-3xl font-bold tracking-tight">Visualy</h1>
                </div>
                <div class="flex items-center space-x-4">
                     <button id="search-nav-btn" class="nav-btn bg-white/20 hover:bg-white/30 font-semibold py-2 px-4 rounded-full transition text-sm">Search</button>
                     <button id="likes-nav-btn" class="nav-btn bg-white/20 hover:bg-white/30 font-semibold py-2 px-4 rounded-full transition text-sm">My Likes</button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main id="main-content" class="container mx-auto max-w-5xl p-4 md:p-8">
            <!-- Search View Content -->
            <div id="search-view">
                 <div class="relative rounded-2xl shadow-2xl overflow-hidden">
                    <img src="https://images.unsplash.com/photo-1600585154340-be6161a56a0c?q=80&w=2070&auto=format&fit=crop" alt="Stylish home background" class="absolute inset-0 w-full h-full object-cover">
                    <div class="absolute inset-0 bg-black/60"></div>
                    <div class="relative p-8 md:p-12 text-center">
                        <h2 class="text-4xl md:text-5xl font-bold text-white mb-4">Find a Home That Gets Your Style.</h2>
                        <p class="text-lg text-white/90 mb-8 max-w-2xl mx-auto">Upload any image that represents your personal vibe—art, fashion, interiors—and we'll find homes that match your unique aesthetic.</p>

                        <!-- Input Section -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-start max-w-4xl mx-auto">
                            <!-- Text Input -->
                            <div>
                                <label for="text-input" class="block text-sm font-medium text-white/80 mb-2 text-left">Refine Location or Style (Optional)</label>
                                <input type="text" id="text-input" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-white focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 transition" placeholder="e.g., 'near downtown Atlanta'">
                            </div>

                            <!-- Image Input -->
                            <div class="flex flex-col items-center justify-center w-full">
                                <label for="image-upload" class="flex flex-col items-center justify-center w-full h-32 md:h-full border-2 border-white/20 border-dashed rounded-lg cursor-pointer bg-white/10 hover:bg-white/20 transition">
                                    <div class="flex flex-col items-center justify-center">
                                        <i id="upload-icon" class="fas fa-plus-circle text-4xl text-white/80 mb-3"></i>
                                        <p id="upload-text" class="mb-2 text-sm text-white/80"><span class="font-semibold">Add Photos (up to 3)</span></p>
                                        <input id="image-upload" type="file" class="hidden" accept="image/*" multiple/>
                                    </div>
                                </label>
                                <div id="image-preview-container" class="mt-4 flex flex-wrap gap-4 justify-center"></div>
                            </div>
                        </div>
                        
                         <!-- Vibe Questions Section -->
                        <div class="mt-6 text-center">
                            <button id="refine-vibe-btn" class="text-white/80 hover:text-white font-semibold">
                                Refine Your Vibe <i class="fas fa-chevron-down ml-1 transition-transform"></i>
                            </button>
                        </div>

                        <div id="vibe-questions" class="hidden mt-6 pt-6 border-t border-white/20">
                             <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <!-- Question 1: Weekend -->
                                <div>
                                    <h4 class="font-semibold text-white mb-3 text-center">Ideal Weekend?</h4>
                                    <div class="space-y-3" data-question="weekend">
                                        <div class="vibe-option p-4 border border-white/20 bg-white/10 text-white/80 rounded-lg cursor-pointer text-center hover:bg-white/20" data-value="A quiet night in with a book">
                                            <i class="fas fa-book-open text-2xl mb-2"></i><p class="text-sm">Quiet Night In</p>
                                        </div>
                                        <div class="vibe-option p-4 border border-white/20 bg-white/10 text-white/80 rounded-lg cursor-pointer text-center hover:bg-white/20" data-value="Hosting a dinner party for friends">
                                             <i class="fas fa-utensils text-2xl mb-2"></i><p class="text-sm">Dinner Party</p>
                                        </div>
                                        <div class="vibe-option p-4 border border-white/20 bg-white/10 text-white/80 rounded-lg cursor-pointer text-center hover:bg-white/20" data-value="Exploring the city's nightlife">
                                             <i class="fas fa-martini-glass-citrus text-2xl mb-2"></i><p class="text-sm">Nightlife</p>
                                        </div>
                                    </div>
                                </div>
                                <!-- Question 2: Colors -->
                                <div>
                                    <h4 class="font-semibold text-white mb-3 text-center">Color Palette?</h4>
                                    <div class="space-y-3" data-question="colors">
                                         <div class="vibe-option p-4 border border-white/20 bg-white/10 text-white/80 rounded-lg cursor-pointer text-center hover:bg-white/20" data-value="Neutral and earthy tones">
                                            <div><span class="color-swatch" style="background-color: #e2e8f0;"></span><span class="color-swatch" style="background-color: #a0aec0;"></span><span class="color-swatch" style="background-color: #718096;"></span></div>
                                            <p class="text-sm mt-2">Neutral & Earthy</p>
                                        </div>
                                         <div class="vibe-option p-4 border border-white/20 bg-white/10 text-white/80 rounded-lg cursor-pointer text-center hover:bg-white/20" data-value="Warm and cozy colors">
                                            <div><span class="color-swatch" style="background-color: #fbd38d;"></span><span class="color-swatch" style="background-color: #f6ad55;"></span><span class="color-swatch" style="background-color: #ed8936;"></span></div>
                                            <p class="text-sm mt-2">Warm & Cozy</p>
                                        </div>
                                         <div class="vibe-option p-4 border border-white/20 bg-white/10 text-white/80 rounded-lg cursor-pointer text-center hover:bg-white/20" data-value="Bold and vibrant shades">
                                            <div><span class="color-swatch" style="background-color: #63b3ed;"></span><span class="color-swatch" style="background-color: #4299e1;"></span><span class="color-swatch" style="background-color: #3182ce;"></span></div>
                                            <p class="text-sm mt-2">Bold & Vibrant</p>
                                        </div>
                                    </div>
                                </div>
                                 <!-- Question 3: Materials -->
                                <div>
                                    <h4 class="font-semibold text-white mb-3 text-center">Primary Material?</h4>
                                    <div class="space-y-3" data-question="materials">
                                        <div class="vibe-option p-4 border border-white/20 bg-white/10 text-white/80 rounded-lg cursor-pointer text-center hover:bg-white/20" data-value="Natural wood and stone">
                                            <i class="fas fa-tree text-2xl mb-2"></i><p class="text-sm">Wood & Stone</p>
                                        </div>
                                        <div class="vibe-option p-4 border border-white/20 bg-white/10 text-white/80 rounded-lg cursor-pointer text-center hover:bg-white/20" data-value="Sleek metal and glass">
                                            <i class="fas fa-city text-2xl mb-2"></i><p class="text-sm">Metal & Glass</p>
                                        </div>
                                        <div class="vibe-option p-4 border border-white/20 bg-white/10 text-white/80 rounded-lg cursor-pointer text-center hover:bg-white/20" data-value="Exposed brick and concrete">
                                            <i class="fas fa-building text-2xl mb-2"></i><p class="text-sm">Brick & Concrete</p>
                                        </div>
                                    </div>
                                </div>
                             </div>
                        </div>

                        <!-- Find Matches Button -->
                        <div class="mt-8 text-center">
                            <button id="find-matches-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-4 px-16 rounded-full transition-transform transform hover:scale-105 shadow-lg focus:outline-none focus:ring-4 focus:ring-indigo-300 text-lg">
                                <span id="btn-text">Find Matches</span>
                                <i id="btn-loader" class="fas fa-spinner fa-spin hidden ml-2"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results Section (for both Search and Likes) -->
            <div id="results-section" class="mt-12 hidden">
                 <div class="flex justify-between items-center mb-6 flex-wrap">
                    <h3 id="results-title" class="text-2xl font-bold text-gray-800 mb-4 sm:mb-0">Comparable Properties</h3>
                </div>
                 <div class="flex justify-end items-center mb-6">
                    <div id="sorting-controls" class="flex items-center space-x-2">
                        <span class="text-sm font-medium text-gray-600">Sort by:</span>
                        <button id="sort-match-btn" class="sort-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-full transition text-sm">Match %</button>
                        <button id="sort-distance-btn" class="sort-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-full transition text-sm">Distance</button>
                    </div>
                </div>
                <div id="results-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <!-- Results will be injected here -->
                </div>
                <div id="load-more-container" class="mt-10 text-center hidden">
                    <button id="load-more-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-12 rounded-full transition-transform transform hover:scale-105 shadow-lg focus:outline-none focus:ring-4 focus:ring-indigo-300">
                        Load More Results
                    </button>
                </div>
                 <div id="no-results-message" class="text-center py-12 text-gray-500 hidden">
                    <!-- Message is set dynamically -->
                </div>
            </div>

             <!-- Error Message -->
            <div id="error-message" class="mt-8 hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg" role="alert">
                <strong class="font-bold">Oops!</strong>
                <span class="block sm:inline" id="error-text">Something went wrong. Please try again.</span>
            </div>
        </main>
    </div>

    <!-- Property Details Modal -->
    <div id="details-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex justify-center items-center p-4">
        <div id="modal-container" class="bg-white rounded-lg shadow-xl w-full max-w-lg relative transition-transform transform scale-95">
            <button id="close-modal-btn" class="absolute top-3 right-4 text-gray-400 hover:text-gray-800 text-2xl font-bold">&times;</button>
            <div id="modal-content" class="p-6">
            </div>
        </div>
    </div>


    <script type="module">
        // --- DOM ELEMENTS ---
        const textInput = document.getElementById('text-input');
        const imageUpload = document.getElementById('image-upload');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const uploadIcon = document.getElementById('upload-icon');
        const uploadText = document.getElementById('upload-text');
        const findMatchesBtn = document.getElementById('find-matches-btn');
        const btnText = document.getElementById('btn-text');
        const btnLoader = document.getElementById('btn-loader');
        const searchNavBtn = document.getElementById('search-nav-btn');
        const likesNavBtn = document.getElementById('likes-nav-btn');
        const searchView = document.getElementById('search-view');
        const resultsSection = document.getElementById('results-section');
        const resultsTitle = document.getElementById('results-title');
        const resultsGrid = document.getElementById('results-grid');
        const sortMatchBtn = document.getElementById('sort-match-btn');
        const sortDistanceBtn = document.getElementById('sort-distance-btn');
        const sortingControls = document.getElementById('sorting-controls');
        const loadMoreContainer = document.getElementById('load-more-container');
        const loadMoreBtn = document.getElementById('load-more-btn');
        const noResultsMessage = document.getElementById('no-results-message');
        const errorMessage = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        const detailsModal = document.getElementById('details-modal');
        const modalContainer = document.getElementById('modal-container');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const modalContent = document.getElementById('modal-content');
        const refineVibeBtn = document.getElementById('refine-vibe-btn');
        const vibeQuestions = document.getElementById('vibe-questions');

        // --- STATE MANAGEMENT ---
        let uploadedImages = [];
        let allFetchedProperties = [];
        let displayedProperties = [];
        let currentPage = 1;
        const propertiesPerPage = 6;
        let vibeAnswers = {};

        // --- EVENT LISTENERS ---
        imageUpload.addEventListener('change', (e) => {
            if (e.target.files) {
                 handleFiles(e.target.files);
            }
        });

        function handleFiles(files) {
            const filesToProcess = Array.from(files).slice(0, 3 - uploadedImages.length);
            filesToProcess.forEach(file => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const imageData = {
                        id: crypto.randomUUID(),
                        mimeType: file.type,
                        base64: event.target.result.split(',')[1],
                        dataUrl: event.target.result,
                    };
                    uploadedImages.push(imageData);
                    renderImagePreviews();
                };
                reader.readAsDataURL(file);
            });
        }
        
        function renderImagePreviews() {
            imagePreviewContainer.innerHTML = '';
            uploadedImages.forEach(imgData => {
                const imgWrapper = document.createElement('div');
                imgWrapper.className = 'relative';
                imgWrapper.innerHTML = `
                    <img src="${imgData.dataUrl}" class="h-20 w-20 object-cover rounded-md shadow-md"/>
                    <button data-id="${imgData.id}" class="remove-img-btn absolute -top-2 -right-2 bg-red-500 text-white rounded-full h-6 w-6 flex items-center justify-center text-xs font-bold">&times;</button>
                `;
                imagePreviewContainer.appendChild(imgWrapper);
            });
            
            imagePreviewContainer.querySelectorAll('.remove-img-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const idToRemove = e.target.dataset.id;
                    uploadedImages = uploadedImages.filter(img => img.id !== idToRemove);
                    renderImagePreviews();
                });
            });
        }


        findMatchesBtn.addEventListener('click', handleFindMatches);
        sortMatchBtn.addEventListener('click', () => sortProperties('match'));
        sortDistanceBtn.addEventListener('click', () => sortProperties('distance'));
        loadMoreBtn.addEventListener('click', displayMoreProperties);
        searchNavBtn.addEventListener('click', showSearchView);
        likesNavBtn.addEventListener('click', showLikesView);
        refineVibeBtn.addEventListener('click', () => {
            vibeQuestions.classList.toggle('hidden');
            refineVibeBtn.querySelector('i').classList.toggle('rotate-180');
        });
        
        vibeQuestions.querySelectorAll('.vibe-option').forEach(option => {
            option.addEventListener('click', (e) => {
                const parent = e.currentTarget.parentElement;
                const question = parent.dataset.question;
                const value = e.currentTarget.dataset.value;

                parent.querySelectorAll('.vibe-option').forEach(opt => opt.classList.remove('selected'));
                e.currentTarget.classList.add('selected');
                vibeAnswers[question] = value;
            });
        });

        // --- INITIALIZATION ---
        showSearchView();


        // --- VIEW MANAGEMENT ---
        function showSearchView() {
            searchView.classList.remove('hidden');
            searchNavBtn.classList.add('nav-btn-active');
            likesNavBtn.classList.remove('nav-btn-active');
            resultsTitle.textContent = "Comparable Properties";
            sortingControls.classList.remove('hidden');
            
            displayedProperties = allFetchedProperties; 
            resultsGrid.innerHTML = '';
            
            if (displayedProperties.length > 0) {
                 currentPage = 1;
                 displayMoreProperties();
                 noResultsMessage.classList.add('hidden');
            } else {
                 resultsSection.classList.add('hidden');
            }
        }

        function showLikesView() {
            searchView.classList.add('hidden');
            likesNavBtn.classList.add('nav-btn-active');
            searchNavBtn.classList.remove('nav-btn-active');
            resultsSection.classList.remove('hidden');
            resultsTitle.textContent = "My Liked Properties";
            sortingControls.classList.add('hidden');
            loadMoreContainer.classList.add('hidden');

            const likedProperties = getLikedProperties();
            displayedProperties = likedProperties;
            resultsGrid.innerHTML = '';
            
            if (likedProperties.length > 0) {
                 noResultsMessage.classList.add('hidden');
                 renderPropertyCards(likedProperties, 0);
            } else {
                 noResultsMessage.classList.remove('hidden');
                 noResultsMessage.innerHTML = `<i class="far fa-heart fa-3x mb-4"></i><p class="text-lg">You haven't liked any properties yet.</p>`;
            }
        }


        // --- CORE LOGIC ---
        async function handleFindMatches() {
            if (uploadedImages.length === 0) {
                showError("Please upload at least one photo to perform an aesthetic match.");
                return;
            }
            showSearchView(); 
            
            const queryText = textInput.value;
            setLoading(true);
            hideError();
            resultsGrid.innerHTML = '';
            resultsSection.classList.add('hidden');
            loadMoreContainer.classList.add('hidden');

            try {
                const properties = await getPropertyDescriptions(queryText, uploadedImages, vibeAnswers);
                if (properties && properties.length > 0) {
                    properties.forEach(p => p.propertyId = crypto.randomUUID());
                    allFetchedProperties = properties;
                    displayedProperties = allFetchedProperties;
                    currentPage = 1;
                    sortProperties('match');
                } else {
                    throw new Error("The AI couldn't find any suitable matches.");
                }
            } catch (error) {
                console.error('Error in matching process:', error);
                showError(error.message || "An unexpected error occurred.");
            } finally {
                setLoading(false);
            }
        }
        
        async function getPropertyDescriptions(queryText, images, vibeData) {
            const prompt = createDetailedPrompt(queryText, vibeData, images.length);
            const payload = createGeminiPayload(prompt, images);
            const apiKey = "YOUR_API_KEY_HERE";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorBody = await response.text();
                throw new Error(`API Error (Gemini): ${response.status} - ${response.statusText}. Details: ${errorBody}`);
            }

            const result = await response.json();
            const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
            
            if (jsonText) {
                const cleanedJsonText = jsonText.replace(/```json/g, '').replace(/```/g, '').trim();
                console.log("Cleaned AI Response Text:", cleanedJsonText);
                try {
                    return JSON.parse(cleanedJsonText);
                } catch (e) {
                    throw new Error(`The AI returned an invalid JSON format. Error: ${e.message}. Raw response was: "${cleanedJsonText}"`);
                }
            } else {
                 throw new Error("Received an empty response from the AI.");
            }
        }
        
        function createDetailedPrompt(queryText, vibeData, imageCount) {
             let prompt = `You are a personal style expert and real estate scout. Your primary task is to translate a user's personal aesthetic from one or more images AND a set of vibe questions into a matching home and lifestyle. Find 18 hyper-realistic, comparable rental properties based on this analysis.

The user's optional text query for refinement is: "${queryText}". 
The user has provided ${imageCount} images to define their style. These are the primary source of truth for the user's personal vibe.
The user has also provided the following answers to vibe questions:
- Ideal Weekend: ${vibeData.weekend || 'Not specified'}
- Color Palette: ${vibeData.colors || 'Not specified'}
- Primary Material: ${vibeData.materials || 'Not specified'}`;

            prompt += `

Your analysis MUST follow these steps:
1.  **Holistic Vibe Deconstruction:** Synthesize ALL uploaded images AND the vibe question answers to create a single, cohesive "Lifestyle Profile."
2.  **Translate to Home Style:** Convert this profile into a corresponding architectural and interior design style.
3.  **Visual Keyword Extraction:** Create a "visualKeywords" field. This MUST be a single string containing 3 to 5 comma-separated keywords. Example: "exposed brick, industrial lighting, large windows". Do NOT exceed 5 keywords. This is a strict rule.
4.  **Lifestyle & Contact Analysis:** For each property, generate realistic details.
    -   **Address:** First, generate a full, realistic address for the property. This is a NON-NEGOTIABLE first step. If you cannot generate a valid address, do not proceed with this property.
    -   **Proximity Details:** Based *only* on the generated address, provide a detailed description string for each proximity category. This string must include an overall score (e.g., "Score: 8/10") and mention at least 2-3 specific, named venues.

**CRITICAL RULES FOR RESPONSE FORMATTING:**
1.  **COMPLETE DATA IS MANDATORY:** Every property object MUST have a valid, non-empty value for ALL fields.
2.  **VALID PROPERTY DETAILS:**
    - \`propertyName\` must be creative and unique.
    - \`address\` MUST be a valid, realistic street address.
    - \`listingUrl\` MUST be a valid, real Google search URL.
    - The 'visualKeywords' string MUST NOT contain more than 5 keywords.
    - All other fields (price, score, contact, proximity) must be realistically filled.
3.  **JSON ONLY:** Your entire response MUST be a single, valid JSON array of 18 properties. Do not include any other text, notes, or markdown.

It is absolutely critical that your response is ONLY a valid JSON array that strictly follows this schema.`;
            return prompt;
        }

        function createGeminiPayload(prompt, images) {
            const parts = [{ text: prompt }];
            images.forEach(img => {
                 parts.push({ inlineData: { mimeType: img.mimeType || 'image/jpeg', data: img.base64 } });
            });
            
            return {
                contents: [{ role: "user", parts }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                propertyName: { type: "STRING" },
                                address: { type: "STRING" },
                                price: { type: "NUMBER" },
                                size: { type: "STRING" },
                                aestheticStyle: { type: "STRING" },
                                vibe: { type: "STRING" },
                                similarityScore: { type: "NUMBER" },
                                distance: { type: "NUMBER" },
                                amenities: { type: "ARRAY", items: { type: "STRING" } },
                                listingUrl: { type: "STRING" },
                                contact: {
                                    type: "OBJECT",
                                    properties: {
                                        name: { type: "STRING" },
                                        phone: { type: "STRING" },
                                        email: { type: "STRING" },
                                    }
                                },
                                proximity: { 
                                    type: "OBJECT", 
                                    properties: {
                                        restaurants: { type: "STRING" },
                                        nightlife: { type: "STRING" },
                                        parks: { type: "STRING" },
                                        transportation: { type: "STRING" }
                                    }
                                },
                                visualKeywords: { type: "STRING" },
                                matchJustification: { type: "STRING" },
                                inferredLocation: { type: "STRING" }
                            }
                        }
                    }
                }
            };
        }
        
        async function generatePropertyImage(prop) {
             const keywordsString = prop.visualKeywords ? prop.visualKeywords : '';
             const imagePrompt = `Photorealistic, exterior shot of a modern rental property named "${prop.propertyName}". Aesthetic style: ${prop.aestheticStyle}. Key visual features MUST include: ${keywordsString}. Located in ${prop.address}. High-end, architectural photography.`;
             const payload = { instances: [{ prompt: imagePrompt }], parameters: { "sampleCount": 1 } };
             const apiKey = "YOUR_API_KEY_HERE"; // IMPORTANT: Replace with your actual API key for deployment
             const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;

             try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) return null;
                const result = await response.json();
                if (result.predictions && result.predictions[0].bytesBase64Encoded) {
                    return `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                }
             } catch (error) {
                console.error("Imagen API error:", error);
             }
             return null;
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        async function processImagesSequentially(propertiesToProcess, startIndex) {
            for (let i = 0; i < propertiesToProcess.length; i++) {
                const prop = propertiesToProcess[i];
                const imageId = `prop-image-${startIndex + i}`;
                const imageContainer = document.getElementById(imageId);

                if (imageContainer && !prop.generatedImageUrl) {
                    const imageUrl = await generatePropertyImage(prop);
                    prop.generatedImageUrl = imageUrl;

                    const currentImageContainer = document.getElementById(imageId);
                    if (currentImageContainer) {
                        if (imageUrl) {
                            const img = new Image();
                            img.src = imageUrl;
                            img.className = 'h-56 w-full object-cover';
                            img.alt = `AI-generated photo of ${prop.propertyName}`;
                            currentImageContainer.replaceWith(img);
                        } else {
                            currentImageContainer.innerHTML = '<i class="fas fa-exclamation-triangle fa-2x"></i><span>Image Failed</span>';
                        }
                    }
                    await sleep(1000);
                }
            }
        }

        function sortProperties(sortBy) {
            if (sortBy === 'match') {
                displayedProperties.sort((a, b) => (b.similarityScore || 0) - (a.similarityScore || 0));
                sortMatchBtn.classList.add('sort-btn-active');
                sortDistanceBtn.classList.remove('sort-btn-active');
            } else if (sortBy === 'distance') {
                displayedProperties.sort((a, b) => (a.distance || 999) - (b.distance || 999));
                sortDistanceBtn.classList.add('sort-btn-active');
                sortMatchBtn.classList.remove('sort-btn-active');
            }
            currentPage = 1;
            resultsGrid.innerHTML = '';
            displayMoreProperties();
        }
        
        function displayMoreProperties() {
            resultsSection.classList.remove('hidden');
            const startIndex = (currentPage - 1) * propertiesPerPage;
            const endIndex = startIndex + propertiesPerPage;
            const propertiesToDisplay = displayedProperties.slice(startIndex, endIndex);

            renderPropertyCards(propertiesToDisplay, startIndex);

            currentPage++;

            if (endIndex >= displayedProperties.length) {
                loadMoreContainer.classList.add('hidden');
            } else {
                loadMoreContainer.classList.remove('hidden');
            }
        }

        function renderPropertyCards(properties, startIndex) {
            const likedProperties = getLikedProperties();
            properties.forEach((prop, index) => {
                const globalIndex = startIndex + index;
                const cardId = `prop-card-${globalIndex}`;
                const imageId = `prop-image-${globalIndex}`;
                const isLiked = likedProperties.some(p => p.propertyId === prop.propertyId);

                const cardWrapper = document.createElement('div');
                cardWrapper.id = cardId;
                cardWrapper.className = "bg-white rounded-xl shadow-md overflow-hidden transition-all card-hover flex flex-col";
                
                let inferredLocationHtml = '';
                if (prop.inferredLocation && globalIndex < propertiesPerPage) {
                    inferredLocationHtml = `<div class="font-semibold text-xs text-purple-600 uppercase tracking-wide py-1 text-center bg-purple-50">
                        <i class="fas fa-map-marker-alt mr-1"></i> Location inferred: ${prop.inferredLocation}
                        </div>`;
                }
                
                let imageHtml;
                if(prop.generatedImageUrl) {
                    imageHtml = `<img src="${prop.generatedImageUrl}" class="h-56 w-full object-cover" alt="AI-generated photo of ${prop.propertyName}">`;
                } else {
                    imageHtml = `<div id="${imageId}" class="h-56 w-full object-cover image-loader">
                            <i class="fas fa-image fa-2x"></i>
                            <span>Generating Image...</span>
                        </div>`;
                }

                cardWrapper.innerHTML = `
                    <div class="relative">
                        ${imageHtml}
                        <div class="absolute top-2 left-2 text-2xl text-white" style="text-shadow: 0 1px 3px rgba(0,0,0,0.5);">
                            <i class="${isLiked ? 'fas' : 'far'} fa-heart like-btn ${isLiked ? 'liked' : ''}" data-property-id="${prop.propertyId}"></i>
                        </div>
                        <div class="absolute top-0 right-0 bg-indigo-500 text-white py-1 px-3 rounded-bl-lg font-bold">${prop.similarityScore || 'N/A'}% Match</div>
                        <div class="absolute bottom-0 left-0 bg-black bg-opacity-50 text-white py-1 px-2 rounded-tr-lg text-sm font-medium">
                            <i class="fas fa-road mr-1"></i> ${prop.distance !== undefined ? `${prop.distance} mi` : 'N/A'}
                        </div>
                    </div>
                    ${inferredLocationHtml}
                    <div class="p-6 flex flex-col flex-grow">
                        <div class="font-semibold text-sm text-indigo-600 uppercase tracking-wide">${prop.aestheticStyle || 'N/A'} &middot; ${prop.vibe || 'N/A'}</div>
                        <h4 class="text-xl font-bold text-gray-900 mt-1">${prop.propertyName || 'Unnamed Property'}</h4>
                        <p class="text-gray-600 mt-1">${prop.address || 'Address not available'}</p>
                        <div class="mt-4 flex justify-between items-center">
                            <p class="text-lg font-bold text-gray-800">${prop.price && typeof prop.price === 'number' ? `$${prop.price.toLocaleString()}/mo` : 'Price not available'}</p>
                            <p class="text-sm text-gray-600">${prop.size || 'Size not available'}</p>
                        </div>
                        <div class="mt-auto pt-4 border-t-2 border-gray-100 flex space-x-2">
                           <button type="button" class="details-btn w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg transition">
                               Details
                           </button>
                           <button type="button" class="listing-btn w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition text-center">
                               View Listing
                           </button>
                        </div>
                    </div>
                `;
                resultsGrid.appendChild(cardWrapper);

                cardWrapper.querySelector('.details-btn').addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    showDetailsModal(prop);
                });
                
                cardWrapper.querySelector('.listing-btn').addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    if (prop.listingUrl && prop.listingUrl.startsWith('http')) {
                        window.open(prop.listingUrl, '_blank');
                    } else {
                        showError("This listing does not have a valid URL.");
                    }
                });
                
                cardWrapper.querySelector('.like-btn').addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    toggleLike(prop, e.target);
                });
            });

             if (resultsGrid.innerHTML === '' && likesNavBtn.classList.contains('nav-btn-active')) {
                noResultsMessage.classList.remove('hidden');
                noResultsMessage.innerHTML = `<i class="far fa-heart fa-3x mb-4"></i><p class="text-lg">You haven't liked any properties yet.</p>`;
            } else if (resultsGrid.innerHTML === '' && searchNavBtn.classList.contains('nav-btn-active')) {
                 noResultsMessage.classList.remove('hidden');
                 noResultsMessage.innerHTML = `<i class="fas fa-search fa-3x mb-4"></i><p class="text-lg">Perform a search to see results.</p>`;
            } else {
                 noResultsMessage.classList.add('hidden');
            }


            processImagesSequentially(properties, startIndex);
        }

        // --- LOCAL STORAGE LIKES ---
        function getLikedProperties() {
            return JSON.parse(localStorage.getItem('likedProperties')) || [];
        }

        function toggleLike(propertyObject, iconElement) {
            let likedProperties = getLikedProperties();
            const propertyId = propertyObject.propertyId;
            const propertyIndex = likedProperties.findIndex(p => p.propertyId === propertyId);

            if (propertyIndex > -1) {
                // Unlike
                likedProperties.splice(propertyIndex, 1);
                iconElement.classList.remove('fas', 'liked');
                iconElement.classList.add('far');
            } else {
                // Like
                likedProperties.push(propertyObject);
                iconElement.classList.remove('far');
                iconElement.classList.add('fas', 'liked');
            }
            localStorage.setItem('likedProperties', JSON.stringify(likedProperties));
            
            if (likesNavBtn.classList.contains('nav-btn-active')) {
                showLikesView();
            }
        }


        // --- UI HELPER FUNCTIONS ---
        function setLoading(isLoading) {
            findMatchesBtn.disabled = isLoading;
            btnText.classList.toggle('hidden', isLoading);
            btnLoader.classList.toggle('hidden', !isLoading);
        }

        function showError(message) {
            errorText.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        function hideError() {
            errorMessage.classList.add('hidden');
        }

        function showDetailsModal(prop) {
            modalContent.innerHTML = ''; // Clear previous content
            
            let keywordsHtml = '<p class="text-sm text-gray-500">No specific aesthetic keywords were identified.</p>';
            if (prop.visualKeywords && typeof prop.visualKeywords === 'string') {
                keywordsHtml = prop.visualKeywords.split(',')
                    .map(keyword => keyword.trim())
                    .filter(k => k)
                    .slice(0, 5) // Ensure we only ever show a max of 5
                    .map(keyword => `<span class="inline-block bg-gray-200 rounded-full px-3 py-1 text-sm font-semibold text-gray-700 mr-2 mb-2">${keyword}</span>`)
                    .join('');
            }
            
            const renderCategory = (category, data, iconClass) => {
                let score = 0;
                let description = data || 'N/A';
                if (typeof data === 'string') {
                    const match = data.match(/Score: (\d+(\.\d+)?)/i);
                    score = match ? parseFloat(match[1]) : 0;
                    description = data.replace(/Score: \d+(\.\d+)?\.\s*/i, '').trim();
                }
                const scoreColor = score > 7 ? 'bg-green-500' : score > 4 ? 'bg-yellow-500' : 'bg-red-500';

                 return `
                 <div>
                    <h6 class="font-semibold text-gray-800 mb-2 flex items-center"><i class="${iconClass} w-6 text-gray-400"></i>${category}</h6>
                     <div class="flex items-center mb-2">
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                           <div class="${scoreColor} h-2.5 rounded-full" style="width: ${score * 10}%"></div>
                        </div>
                        <span class="font-bold ml-3 text-gray-800">${score}/10</span>
                    </div>
                    <p class="text-sm text-gray-600 pl-6">${description}</p>
                 </div>
            `;
            }

            modalContent.innerHTML = `
                <h4 class="text-xl font-bold text-gray-900 mb-4">${prop.propertyName || 'Property Details'}</h4>
                <div class="space-y-6">
                     <div>
                        <h5 class="font-bold text-gray-800 mb-2 border-b pb-2">Aesthetic Profile</h5>
                        <div class="flex flex-wrap">
                           ${keywordsHtml}
                        </div>
                    </div>
                     <div>
                        <h5 class="font-bold text-gray-800 mb-2 border-b pb-2">Lifestyle & Vibe</h5>
                        <div class="space-y-4 mt-2">
                           ${renderCategory('Food & Restaurants', prop.proximity?.restaurants, 'fas fa-utensils')}
                           ${renderCategory('Nightlife & Bars', prop.proximity?.nightlife, 'fas fa-martini-glass-citrus')}
                           ${renderCategory('Parks & Recreation', prop.proximity?.parks, 'fas fa-dog')}
                           ${renderCategory('Public Transportation', prop.proximity?.transportation, 'fas fa-bus')}
                        </div>
                    </div>
                     <div>
                        <h5 class="font-bold text-gray-800 mb-2 border-b pb-2">Contact Information</h5>
                        <div class="text-sm text-gray-600 space-y-2">
                           <p><i class="fas fa-user-tie w-6 text-gray-400"></i> <strong>Agent:</strong> ${prop.contact?.name || 'N/A'}</p>
                           <p><i class="fas fa-phone w-6 text-gray-400"></i> <strong>Phone:</strong> ${prop.contact?.phone || 'N/A'}</p>
                           <p><i class="fas fa-envelope w-6 text-gray-400"></i> <strong>Email:</strong> ${prop.contact?.email || 'N/A'}</p>
                        </div>
                    </div>
                </div>
            `;
            detailsModal.classList.remove('hidden');
            setTimeout(() => modalContainer.classList.add('scale-100'), 10);
        }

        function hideDetailsModal() {
            modalContainer.classList.remove('scale-100');
            setTimeout(() => detailsModal.classList.add('hidden'), 200);
        }

        closeModalBtn.addEventListener('click', hideDetailsModal);
        detailsModal.addEventListener('click', (e) => {
            if (e.target === detailsModal) hideDetailsModal();
        });
    </script>
</body>
</html>
